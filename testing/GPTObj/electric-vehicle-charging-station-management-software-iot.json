{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "CloudFormation template for electric vehicle charging station IoT architecture.",
    "Resources": {
        "LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Handler": "index.handler",
                "Role": {
                    "Ref": "LambdaExecutionRole"
                },
                "Code": {
                    "ZipFile": "exports.handler = async (event) => { console.log(event); };"
                },
                "Runtime": "nodejs14.x"
            }
        },
        "PrivateCA": {
            "Type": "AWS::ACMPCA::CertificateAuthority",
            "Properties": {
                "Type": "ROOT",
                "KeyAlgorithm": "RSA_2048",
                "SigningAlgorithm": "SHA256WITHRSA",
                "Subject": {
                    "Country": "US",
                    "Organization": "Example",
                    "OrganizationalUnit": "IT",
                    "State": "California",
                    "CommonName": "example.com"
                }
            }
        },
        "IoTCoreTopicRule": {
            "Type": "AWS::IoT::TopicRule",
            "Properties": {
                "TopicRulePayload": {
                    "Sql": "SELECT * FROM 'iot/topic'",
                    "Actions": [
                        {
                            "Lambda": {
                                "FunctionArn": {
                                    "Ref": "LambdaFunction"
                                }
                            }
                        }
                    ]
                }
            }
        },
        "IoTDeviceManagement": {
            "Type": "AWS::IoT::Thing",
            "Properties": {
                "ThingName": "IoTDevice"
            }
        },
        "TimestreamDatabase": {
            "Type": "AWS::Timestream::Database",
            "Properties": {
                "DatabaseName": "ChargingStationTelemetry"
            }
        },
        "S3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": "charging-station-data"
            }
        },
        "DynamoDBTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": "ChargingStationData",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "Id",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "Id",
                        "KeyType": "HASH"
                    }
                ],
                "BillingMode": "PAY_PER_REQUEST"
            }
        },
        "CloudFrontDistribution": {
            "Type": "AWS::CloudFront::Distribution",
            "Properties": {
                "DistributionConfig": {
                    "Origins": [
                        {
                            "DomainName": {
                                "Fn::Sub": "s3-${AWS::Region}.amazonaws.com"
                            },
                            "Id": "S3Origin"
                        }
                    ],
                    "DefaultCacheBehavior": {
                        "TargetOriginId": "S3Origin",
                        "ViewerProtocolPolicy": "redirect-to-https"
                    },
                    "Enabled": true
                }
            }
        },
        "CognitoUserPool": {
            "Type": "AWS::Cognito::UserPool",
            "Properties": {
                "UserPoolName": "ChargingStationUserPool"
            }
        },
        "QuickSightDashboard": {
            "Type": "AWS::QuickSight::Dashboard",
            "Properties": {
                "AwsAccountId": {
                    "Ref": "AWS::AccountId"
                },
                "DashboardId": "ChargingStationDashboard",
                "Name": "ChargingStationDashboard",
                "SourceEntity": {
                    "SourceTemplate": {
                        "Arn": "arn:aws:quicksight:us-east-1:aws:template/ChargingStationTemplate"
                    }
                }
            }
        },
        "ApiGateway": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": "ChargingStationAPI"
            }
        },
        "SQSQueue": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "QueueName": "ChargingStationQueue"
            }
        },
        "IoTDefender": {
            "Type": "AWS::IoT::SecurityProfile",
            "Properties": {
                "SecurityProfileName": "IoTDefenderProfile"
            }
        },
        "CloudWatchAlarm": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
                "AlarmName": "HighLatencyAlarm",
                "ComparisonOperator": "GreaterThanThreshold",
                "EvaluationPeriods": 1,
                "MetricName": "Latency",
                "Namespace": "AWS/IoT",
                "Period": 60,
                "Statistic": "Average",
                "Threshold": 100
            }
        },
        "SageMakerNotebook": {
            "Type": "AWS::SageMaker::NotebookInstance",
            "Properties": {
                "InstanceType": "ml.t2.medium",
                "RoleArn": {
                    "Ref": "SageMakerExecutionRole"
                },
                "NotebookInstanceName": "EVChargingStationNotebook"
            }
        }
    }
}