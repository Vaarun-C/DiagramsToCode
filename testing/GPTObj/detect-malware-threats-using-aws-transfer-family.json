{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "CloudFormation template for detecting malware threats using AWS Transfer Family.",
    "Resources": {
        "TransferFamilyServer": {
            "Type": "AWS::Transfer::Server",
            "Properties": {
                "ProtocolDetails": {
                    "As2Transports": [
                        "HTTPS"
                    ]
                },
                "IdentityProviderType": "SERVICE_MANAGED"
            }
        },
        "S3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": "transfer-family-storage-bucket"
            }
        },
        "TransferWorkflowLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": "TransferWorkflowFunction",
                "Runtime": "python3.9",
                "Handler": "lambda_function.lambda_handler",
                "Code": {
                    "ZipFile": "def lambda_handler(event, context):\n    print('AWS Transfer Workflow Function Triggered')"
                },
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                }
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "TransferLambdaPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:*",
                                        "logs:*"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "SecretsManager": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": "TransferFamilySecret",
                "Description": "Secret for custom authentication"
            }
        },
        "EventBridgeScheduler": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name": "UpdateVirusDefinitions",
                "ScheduleExpression": "rate(1 day)",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "UpdateCodeBuildProject",
                                "Arn"
                            ]
                        },
                        "Id": "TargetId"
                    }
                ]
            }
        },
        "UpdateCodeBuildProject": {
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "Name": "UpdateVirusDefinitions",
                "Source": {
                    "Type": "GITHUB",
                    "Location": "https://github.com/your-repo/virus-definitions"
                },
                "Artifacts": {
                    "Type": "NO_ARTIFACTS"
                },
                "Environment": {
                    "ComputeType": "BUILD_GENERAL1_SMALL",
                    "Image": "aws/codebuild/standard:5.0",
                    "Type": "LINUX_CONTAINER"
                },
                "ServiceRole": {
                    "Fn::GetAtt": [
                        "CodeBuildExecutionRole",
                        "Arn"
                    ]
                }
            }
        },
        "CodeBuildExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codebuild.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CodeBuildPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ecr:*",
                                        "logs:*",
                                        "s3:*"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "ECRRepository": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "RepositoryName": "malware-definitions"
            }
        }
    }
}